name: Merge Approved PR

on:
  workflow_call:
    inputs:
      pr-number:
        required: true
        type: number
        description: 'The number of the pull request to process'
    secrets:
      github-token:
        required: true
        description: 'GitHub token with permissions to merge'

jobs:
  merge-pr:
    runs-on: ubuntu-latest
    steps:
      # Fetch PR metadata (head and base branches) using the GitHub API
      - name: Get PR Details
        id: get-pr
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.github-token }}
          script: |
            // Fetch full details of the pull request associated with the comment
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: ${{ inputs.pr-number }}
            });
            
            // Output the base and head branch names for subsequent steps
            core.setOutput('base', pr.base.ref);
            core.setOutput('head', pr.head.ref);

      # Verify that the PR targets 'main' from 'stable'
      - name: Verify Branch Names
        id: verify-branches
        run: |
          # Define the required branch pattern
          REQUIRED_BASE="main"
          REQUIRED_HEAD="stable"
          
          # Get actual values from the previous step
          ACTUAL_BASE="${{ steps.get-pr.outputs.base }}"
          ACTUAL_HEAD="${{ steps.get-pr.outputs.head }}"
          
          # Compare actual branches against requirements
          if [[ "$ACTUAL_BASE" != "$REQUIRED_BASE" ]] || [[ "$ACTUAL_HEAD" != "$REQUIRED_HEAD" ]]; then
            echo "Skipping: PR must be from '$REQUIRED_HEAD' to '$REQUIRED_BASE'. Found $ACTUAL_HEAD -> $ACTUAL_BASE"
            echo "should_skip=true" >> $GITHUB_OUTPUT
          else
            echo "Branches match requirements: Source '$ACTUAL_HEAD' -> Target '$ACTUAL_BASE'."
            echo "should_skip=false" >> $GITHUB_OUTPUT
          fi

      # Check if the PR has the required approval status
      - name: Verify Approval
        id: verify-approval
        if: success() && steps.verify-branches.outputs.should_skip != 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.github-token }}
          script: |
            // Fetch all reviews for the PR
            const { data: reviews } = await github.rest.pulls.listReviews({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: ${{ inputs.pr-number }}
            });
            
            // Check if there is at least one review with the state 'APPROVED'
            const approved = reviews.some(review => review.state === 'APPROVED');
            if (!approved) {
              core.setFailed('Skipping: PR is not approved.');
            } else {
              console.log('PR approval check passed.');
            }

      # Execute the merge if all checks pass
      - name: Merge PR
        if: success() && steps.verify-branches.outputs.should_skip != 'true'
        uses: actions/github-script@v7
        env:
          BASE_REF: ${{ steps.get-pr.outputs.base }}
          HEAD_REF: ${{ steps.get-pr.outputs.head }}
        with:
          github-token: ${{ secrets.github-token }}
          script: |
            try {
              // Perform the merge using the 'merge' method (creates a merge commit, does not squash)
              await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: ${{ inputs.pr-number }},
                merge_method: 'merge'
              });
              console.log(`PR merged successfully: Source '${process.env.HEAD_REF}' -> Target '${process.env.BASE_REF}'.`);
            } catch (error) {
              core.setFailed(`Merge failed: ${error.message}`);
            }
