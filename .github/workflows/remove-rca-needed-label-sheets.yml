name: Remove RCA-needed Label

on:
  workflow_call:
    inputs:
      dry_run:
        description: 'Run in dry-run mode (no changes made)'
        required: false
        default: 'false'
        type: string
      spreadsheet_id:
        description: 'Google Spreadsheet ID (must be provided by consuming repository)'
        required: true
        type: string
      sheet_name:
        description: 'Sheet tab name (uses default if not provided)'
        required: false
        default: 'Form Responses 1'
        type: string
      github-tools-version:
        description: 'The version of github-tools to use. Defaults to main.'
        required: false
        default: 'main'
        type: string
    secrets:
      github-token:
        description: 'GitHub token with issues write permissions'
        required: true
      google-application-creds-base64:
        description: 'Base64 encoded Google application service account credentials'
        required: true

permissions:
  issues: write
  contents: read

jobs:
  remove-rca-labels:
    name: Remove RCA-needed Labels Based on Sheet Data
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout github-tools
        uses: actions/checkout@v4
        with:
          repository: MetaMask/github-tools
          ref: ${{ inputs.github-tools-version }}
          token: ${{ secrets.github-token }}
          path: github-tools

      - name: Checkout consuming repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.github-token }}
          # The script needs to run in the context of the consuming repository
          # So we don't specify a path here, it checks out to the root

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install additional dependencies
        run: |
          # Create a temporary directory for npm dependencies to avoid conflicts with Yarn projects
          mkdir -p /tmp/rca-workflow-deps
          cd /tmp/rca-workflow-deps
          
          # Initialize a minimal package.json
          echo '{"name": "rca-workflow-deps", "version": "1.0.0"}' > package.json
          
          # Pin exact versions for security and reproducibility in CI
          npm install --save-exact \
            @actions/core@1.10.1 \
            @actions/github@6.0.0 \
            googleapis@144.0.0 \
            tsx@4.7.1

      - name: Run RCA Google Sheets check
        run: |
          # Use the dependencies from the temporary directory
          # --no-config prevents tsx from looking for tsconfig files
          cd /tmp/rca-workflow-deps
          NODE_PATH=/tmp/rca-workflow-deps/node_modules npx tsx --no-config $GITHUB_WORKSPACE/github-tools/.github/scripts/remove-rca-needed-label-sheets.ts
        env:
          GITHUB_TOKEN: ${{ secrets.github-token }}
          GOOGLE_SHEETS_CREDENTIALS: ${{ secrets.google-application-creds-base64 }}
          DRY_RUN: ${{ inputs.dry_run }}
          SPREADSHEET_ID: ${{ inputs.spreadsheet_id }}
          SHEET_NAME: ${{ inputs.sheet_name }}
