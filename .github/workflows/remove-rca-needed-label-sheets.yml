name: Remove RCA-needed Label

on:
  workflow_call:
    inputs:
      dry_run:
        description: 'Run in dry-run mode (no changes made)'
        required: false
        default: 'false'
        type: string
      spreadsheet_id:
        description: 'Google Spreadsheet ID (must be provided by consuming repository)'
        required: true
        type: string
      sheet_name:
        description: 'Sheet tab name (uses default if not provided)'
        required: false
        default: 'Form Responses 1'
        type: string
    secrets:
      github-token:
        description: 'GitHub token with issues write permissions'
        required: true
      google-application-creds-base64:
        description: 'Base64 encoded Google application service account credentials'
        required: true

permissions:
  issues: write
  contents: read

jobs:
  remove-rca-labels:
    name: Remove RCA-needed Labels Based on Sheet Data
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout consuming repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.github-token }}

      - name: Checkout GitHub tools repository
        uses: actions/checkout@v5
        with:
          repository: ${{ github.action_repository }}
          ref: ${{ github.action_ref }}
          path: ./.github-tools

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Run RCA Google Sheets check
        run: |
          # Move to .github-tools directory where our script lives
          cd ./.github-tools/.github/scripts

          # Create a simple package.json for npm to work with
          echo '{}' > package.json

          # Install exact versions of required packages locally
          npm install --no-save --no-package-lock \
            @actions/core@1.10.1 \
            @actions/github@6.0.0 \
            googleapis@144.0.0 \
            tsx@4.7.1

          # Run the script with tsx
          npx tsx remove-rca-needed-label-sheets.ts
        env:
          GITHUB_TOKEN: ${{ secrets.github-token }}
          GOOGLE_SHEETS_CREDENTIALS: ${{ secrets.google-application-creds-base64 }}
          DRY_RUN: ${{ inputs.dry_run }}
          SPREADSHEET_ID: ${{ inputs.spreadsheet_id }}
          SHEET_NAME: ${{ inputs.sheet_name }}
